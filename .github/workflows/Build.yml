# .github/workflows/build-telegram-ios.yml

name: Build Telegram iOS (Unsigned)

on:
  workflow_dispatch: # Allows manual triggering
  # push: # Uncomment and adjust if you want it to run on pushes
  #   branches:
  #     - master # Or whichever branch Telegram uses as main development branch

jobs:
  build:
    name: Build Unsigned Telegram IPA
    runs-on: macos-latest # Use the latest available macOS runner

    # Define environment variables accessible by steps below
    # These secrets MUST be configured in your repository's Settings > Secrets and variables > Actions
    env:
      TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
      TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
      # Force non-interactive mode for scripts if needed (sometimes helps in CI)
      DEBIAN_FRONTEND: noninteractive
      # Define path for the generated JSON config file
      CONFIG_JSON_PATH: ${{ github.workspace }}/telegram_config.json
      # Define path for Make.py artifacts (IPA, DSYMs zip)
      BUILD_OUTPUT_PATH: ${{ github.workspace }}/build_output

    steps:
      - name: Check for Secrets Availability
        if: env.TELEGRAM_API_ID == '' || env.TELEGRAM_API_HASH == ''
        run: |
          echo "Error: TELEGRAM_API_ID or TELEGRAM_API_HASH secrets are not set."
          echo "Please configure them in your repository's Settings > Secrets and variables > Actions."
          exit 1
        shell: bash

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # If running this in your fork, remove the 'repository:' line below
          # repository: TelegramMessenger/Telegram-iOS
          submodules: 'recursive' # Important for fetching all dependencies

      # Optional: Select specific Xcode version if needed (Check .xcode-version)
      # - name: Select Xcode version
      #   run: |
      #     # ... (Xcode selection logic) ...
      #   shell: bash

      - name: Check Tools Versions
        run: |
          xcodebuild -version
          python3 --version
          # bazel --version # Check bazel if prepare script doesn't guarantee it
        shell: bash

      # Setup likely still involves Bazel preparation called by Make.py or needed beforehand
      - name: Set up Build Environment (Bazel, etc.)
        run: |
          # Run preparation scripts mentioned in README, likely still needed by Make.py
          # Adjust paths/scripts based on current README/repo structure
          if [ -f "build-system/prepare-bazel.sh" ]; then
             echo "Running prepare-bazel.sh..."
            ./build-system/prepare-bazel.sh
          else
             echo "Warning: build-system/prepare-bazel.sh not found."
             # Consider installing bazel via brew if script is missing and needed
          fi
          # Add any other setup steps mentioned in README (e.g., pip install) if required by Make.py
        shell: bash

      # --- Generate Configuration JSON ---
      - name: Generate Configuration JSON
        run: |
          # Path now uses github.workspace as defined in env block
          echo "Generating build configuration at ${{ env.CONFIG_JSON_PATH }}"
          # Using printf for safer handling of potential special characters in secrets
          # Ensure proper JSON quoting (strings vs booleans)
          printf '{\n' > "${{ env.CONFIG_JSON_PATH }}"
          printf '  "bundle_id": "org.githubactions.telegram.temp",\n' >> "${{ env.CONFIG_JSON_PATH }}"
          # Use the API keys from environment variables (secrets)
          printf '  "api_id": "%s",\n' "${{ env.TELEGRAM_API_ID }}" >> "${{ env.CONFIG_JSON_PATH }}"
          printf '  "api_hash": "%s",\n' "${{ env.TELEGRAM_API_HASH }}" >> "${{ env.CONFIG_JSON_PATH }}"
          # Placeholder/default values for other fields suitable for unsigned build
          printf '  "team_id": "",\n' >> "${{ env.CONFIG_JSON_PATH }}" # Blank Team ID should signal unsigned build
          printf '  "app_center_id": "0",\n' >> "${{ env.CONFIG_JSON_PATH }}"
          printf '  "is_internal_build": "true",\n' >> "${{ env.CONFIG_JSON_PATH }}" # Mark as internal/CI build
          printf '  "is_appstore_build": "false",\n' >> "${{ env.CONFIG_JSON_PATH }}" # Not an App Store build
          printf '  "appstore_id": "0",\n' >> "${{ env.CONFIG_JSON_PATH }}"
          printf '  "app_specific_url_scheme": "tg",\n' >> "${{ env.CONFIG_JSON_PATH }}"
          printf '  "premium_iap_product_id": "",\n' >> "${{ env.CONFIG_JSON_PATH }}"
          printf '  "enable_siri": false,\n' >> "${{ env.CONFIG_JSON_PATH }}" # JSON boolean false
          printf '  "enable_icloud": false\n' >> "${{ env.CONFIG_JSON_PATH }}" # JSON boolean false - last line, no comma
          printf '}\n' >> "${{ env.CONFIG_JSON_PATH }}"

          echo "Configuration file content:"
          cat "${{ env.CONFIG_JSON_PATH }}"
        shell: bash


      # --- Main Build Step using Make.py ---
      - name: Build App using Make.py (Unsigned)
        run: |
          # Using corrected path to Make.py
          MAKE_PY_SCRIPT_PATH="build-system/Make/Make.py"

          if [ ! -f "${MAKE_PY_SCRIPT_PATH}" ]; then
            echo "Error: Build script not found at expected location: ${MAKE_PY_SCRIPT_PATH}"
            exit 1
          fi

          echo "Starting Make.py build using ${MAKE_PY_SCRIPT_PATH}..."

          # Execute Make.py build command - Putting command on a SINGLE LINE to avoid shell parsing issues with backslashes
          python3 "${MAKE_PY_SCRIPT_PATH}" build --configurationPath="${{ env.CONFIG_JSON_PATH }}" --output-build-artifacts-path="${{ env.BUILD_OUTPUT_PATH }}" --configuration=release_arm64 buildNumber=100001 --codesigningInformationPath=build-system/fake-codesigning

          # If Make.py needs other flags identified from README, add them to the end of the single line above. E.g:
          # python3 "${MAKE_PY_SCRIPT_PATH}" build --configurationPath="${{ env.CONFIG_JSON_PATH }}" --output-build-artifacts-path="${{ env.BUILD_OUTPUT_PATH }}" --configuration=release_universal --some-other-flag

          echo "Make.py build finished. Artifacts should be in ${{ env.BUILD_OUTPUT_PATH }}"
          ls -lA "${{ env.BUILD_OUTPUT_PATH }}" # List output directory contents
        shell: bash
        # API Keys are passed via environment variables implicitly to the JSON generation step

      # --- Package IPA Step (REMOVED) ---
      # This step is no longer needed as Make.py copies the IPA directly when using --output-build-artifacts-path

      - name: Upload Unsigned IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Telegram-iOS-Unsigned-IPA
          # Path directly to the IPA file copied by Make.py
          path: ${{ env.BUILD_OUTPUT_PATH }}/Telegram.ipa
          if-no-files-found: error # Fail the step if IPA is missing

      - name: Upload DSYM Artifact (Optional)
        # The Make.py script also creates a Telegram.DSYMs.zip
        if: success() # Only upload if build succeeded
        uses: actions/upload-artifact@v4
        with:
          name: Telegram-iOS-DSYMs
          path: ${{ env.BUILD_OUTPUT_PATH }}/Telegram.DSYMs.zip
          if-no-files-found: ignore # Don't fail if DSYM zip is missing for some reason

      - name: Clean up build directories (optional)
        if: always() # Run even if previous steps fail
        run: |
          echo "Cleaning up intermediate build directories..."
          rm -rf "${{ env.BUILD_OUTPUT_PATH }}" # Remove Make.py output dir
          # No need to remove runner.temp/ipa_output anymore
          rm -f "${{ env.CONFIG_JSON_PATH }}" # Remove generated config file
        shell: bash